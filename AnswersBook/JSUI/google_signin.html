<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0,  maximum-scale=1.0, user-scalable=0"/>
    <title>JSUI tutorial</title>
    <link rel="stylesheet" href="./res/main.css"/>

    <script src="/coveo-search-ui/bin/js/CoveoJsSearch.Dependencies.js"></script>
    <script src="/coveo-search-ui/bin/js/CoveoJsSearch.min.js"></script>
    <script src="/coveo-search-ui/bin/js/templates/templatesNew.js"></script>
    <link rel="stylesheet" href="/coveo-search-ui/bin/css/CoveoFullSearchNewDesign.css"/>

    <meta name="google-signin-client_id" content="YOUR-GOOGLE-CLIENT-ID">
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // show Sign in button
        document.getElementById('btn-sign-in').style.display = 'block';
        document.getElementById('btn-sign-out').style.display = 'none';
      });

      function initSearch(accessToken) {
        Coveo.SearchEndpoint.endpoints['default'] = new Coveo.SearchEndpoint({
          restUri: 'https://platform.cloud.coveo.com/rest/search',
          accessToken: accessToken
        });

        Coveo.init(document.querySelector('#search'));
      }

      function onSignIn(googleUser) {
        // hide Sign in button, show Sign out
        document.getElementById('btn-sign-in').style.display = 'none';
        document.getElementById('btn-sign-out').style.display = 'block';

        var id_token = googleUser.getAuthResponse().id_token,
          profile = googleUser.getBasicProfile();
        document.getElementById('user').innerText = decodeURIComponent(profile.getName() + ' | ' + profile.getEmail());

        // Request Search Token for this user to the back end (see jsui-tutorial/google.js)
        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/x-www-form-urlencoded");
        var options = {
          method: 'POST',
          headers: myHeaders,
          body: 'idtoken=' + id_token
        };

        var tokenRequest = new Request('/token', options);
        fetch(tokenRequest).then( function(response) {
          return response.json().then(function(json) {
            initSearch(json.token);
          })
        });
      }

      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
          window.location='';
        });
      }
    </script>
  </head>
  <body>
    <header style="display:flex;padding: 0 20px;">
      <div class="logos" style="flex:1">
        <a href="http://www.coveo.com" class="logo" title="Coveo"></a>
      </div>

      <!-- placeholder to show the user name -->
      <span id="user"></span>

      <!-- Sign in button, will be generated by the Google API -->
      <div id="btn-sign-in" style="display:none;margin:auto;" class="g-signin2" data-onsuccess="onSignIn"></div>

      <!-- There's no support for sign-out button in the Google API, so this is a duplicate of the generated markup for the Sign in -->
      <div id="btn-sign-out" onclick="signOut();" style="display:none;margin:auto;height:36px;width:120px;display:inline-block" class="abcRioButton abcRioButtonLightBlue">
        <div class="abcRioButtonContentWrapper">
          <div class="abcRioButtonIcon" style="padding:8px">
            <div style="width:18px;height:18px;" class="abcRioButtonSvgImageWithFallback abcRioButtonIconImage abcRioButtonIconImage18">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewbox="0 0 48 48" class="abcRioButtonSvg"><g><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></g></svg>
            </div>
          </div>
          <span style="font-size:13px;line-height:34px;" class="abcRioButtonContents">Sign out</span>
        </div>
      </div>
    </header>

    <div class="main-content flex1">

      <div id="search" class="CoveoSearchInterface" data-enable-history="true" data-design="new">
        <div class="coveo-search-section">
          <div class="CoveoSettings"></div>
          <div class="CoveoSearchbox"></div>
        </div>

        <div class="coveo-main-section">
          <div class="coveo-facet-column">
            <div class="CoveoFacet" data-title="Source" data-field="@source"></div>
            <div class="CoveoFacet" data-title="Type" data-field="@objecttype"></div>
            <div class="CoveoFacet" data-title="FileType" data-field="@filetype" ></div>
            <div class="CoveoFacet" data-title="Author" data-field="@author"></div>
            <div class="CoveoFacet" data-title="Year" data-field="@year"></div>
            <div class="CoveoFacet" data-title="Month" data-field="@month"></div>
          </div>

          <div class="coveo-results-column">
            <div class="CoveoResultList" data-wait-animation="fade" data-auto-select-fields-to-include="true"></div>
          </div>
        </div>

      </div>

    </div>
    <footer>
      <a href="http://www.coveo.com/en/privacy">Privacy Policy</a> | Â© 2017 Coveo Solutions Inc.<span class="subfooter_br"> All Rights Reserved.</span>
    </footer>

  </body>
</html>
